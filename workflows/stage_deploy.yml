name: Stage Push Docker Image

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    
    steps:
      - name: Set up Go 1.x
        uses: actions/setup-go@v2
        with:
          go-version: ^1.18

      - uses: actions/checkout@v3
      - name: Setup snyk
        run: |
          curl https://static.snyk.io/cli/latest/snyk-linux -o snyk
          chmod +x snyk
          sudo mv ./snyk /usr/local/bin

      - name: Run Snyk to check for vulnerabilities
        continue-on-error: true
        run: snyk test
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: Build variables
        id: vars
        shell: bash
        run: |
          echo "##[set-output name=branch;]$(echo ${GITHUB_REF#refs/heads/})"
          echo "::set-output name=sha_short::$(git rev-parse --short HEAD)"
          
      - name: Compile code
        run: make build

      - name: Test
        run: |
          CGO_ENABLED=0 go test ./...

      - name: Configure AWS credentials
        if: github.ref == 'refs/heads/main'
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Login to Amazon ECR
        if: github.ref == 'refs/heads/main'
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1

      - name: Build image
        if: github.ref == 'refs/heads/main'
        env:
          DOCKER_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          VERSION: ${{ steps.vars.outputs.sha_short }}
        run: make docker-build

      - name: Tag image and push to ECR
        if: github.ref == 'refs/heads/main'
        env:
          DOCKER_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          VERSION: ${{ steps.vars.outputs.sha_short }}
        run: make docker-release

      - name: Check out backend-deploy
        if: github.ref == 'refs/heads/main'
        uses: actions/checkout@master
        with:
          repository: c4ad/backend-deploy
          token: ${{ secrets.GH_PAT }}
          path: backend-deploy

      - name: Render Stage backend deploy YAML
        if: github.ref == 'refs/heads/main'
        uses: nowactions/envsubst@v1
        with:
          input: backend-deploy/apps/envs/stage/api-server.yaml.tmpl
          output: backend-deploy/apps/envs/stage/api-server.yaml
        env:
          IMAGE_TAG: ${{ steps.vars.outputs.sha_short }}

      - name: Push changes
        if: github.ref == 'refs/heads/main'
        working-directory: ./backend-deploy
        run: |
          echo "updated build id for stage $(echo ${IMAGE_TAG})"
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add apps/envs/stage/api-server.yaml
          git commit -m "updated build id for stage $(echo ${IMAGE_TAG})"
          git push
